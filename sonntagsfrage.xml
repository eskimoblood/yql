<?xml version="1.0" encoding="UTF-8"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
  <meta>
    <sampleQuery>select * from {table} where bundesland='berlin';</sampleQuery>
	<author>Andreas Köberle</author>
  </meta>
  <bindings>
    <select itemPath="" produces="XML">
      <urls>
        <url></url>
      </urls>
      <inputs>
        <key id='bundesland' type='xs:string' paramType='variable' required="true" />
        <key id='metadata' type='xs:boolean' paramType='variable' required="false" />
      </inputs>
      <execute><![CDATA[
          // Your javascript goes here. We will run it on our servers
          		var process = function(){
          			var json = grabData(),
						keys = [],
						key,
						isParty = [],
						ths = json.head,
						tds = json.body,
						i, j, k, l = ths.length,
						results = [],
						dateColumn,
						isParty;

					for (i = 0; i < l; i++) {
						key = ths[i].p.toString();
						if(key == 'GR\ufffdNE') key = 'GRÜNE';
						keys.push(key);
						isParty.push(key.toLowerCase().match(/spd|cdu|fdp|grüne|linke|sonstige/) != null);
						if(ths[i].p === 'Datum') dateColumn = i;
					}

					for (i = 0, l= tds.length; i<l; i++) {
						var td = tds[i].td,
							r  = {parties: {}, meta: {}},
							dateString;
							
						if(td[0].colspan == 4) {
							dateString = td[0].p.match(/[0-9].*/g)[0];	
						} else {
							dateString = td[dateColumn].p;
						}
						dateString = dateString.split('.');
						r.date  = new Date (dateString[2] ,  (dateString[1] -1) , dateString[0]).toString();
	
						for (j = 0, k = td.length; j < k; j++) {
						
							var position = j;
							if (td[j].colspan) {	
								var string = td[j].p;
								if(metadata) r.meta = {Quelle: string};
								string = string.split(' ');
								string = string[string.length-1].split('.');
								date = 'D' + string[2] + '.' + string[1] + '.' + string[0];
								position = j+ 5;
								y.log(keys[position]);
							}
							var key = keys[position];
						
							if (j != dateColumn && key != '\u00a0' && (metadata || isParty[position])) {
								var value  = td[j].p || td[j].a || '';
								value = value.content || value;
								if (isParty[position]) value = parseInt(value) || null;
								r[isParty[position] ? 'parties' : 'meta'][key] = value;
							}
						}
						results.push(r);
					}
					return {result:results};
				}

				var grabData = function() {
					var r = {};

					r.head = getTrs('thead').th,
					r.body = getTrs('tbody');
					return r;
				}

				var getTrs = function(typ) {
					var url = 'http://www.wahlrecht.de/umfragen/landtage/' + bundesland + '.htm'; 
					return y.xmlToJson(y.query("select * from html where url = '" + url + "' and xpath=\"//" + typ +"/tr\"").results).results.tr;
				} 

				response.object =  process();
      ]]></execute>
    </select>
  </bindings>
</table>